/* https://github.com/qinshenxue/mdeditor */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.mdeditor=e()}(this,function(){"use strict";var w={title:/^#{1,6}.+$/,ul:/^[\.\-\*]\s+.+$/,ol:/^\d+\.\s?.+$/,blockquote:/^!?>.+?$/,code:/^\`{3}.*$/,table:/^(\|[^|]+)+\|\s*$/,align:/^(\|\s*:?-+:?\s*)+\|\s*$/,hr:/^(\*|\_|\-){3,}$/,img:/\!\[(.*?)\]\((.*?)\)/g,a:/\[((?:[^\(\)\[\]]|\\\[|\\\]|\\\(|\\\))+)\]\((.+?)\)/g,b:/\*\*(.+?)\*\*/g,i:/\*(.+?)\*/g,inlineCode:/\`(.+?)\`/g};function b(t,e){for(var n=[],r=0,s=e.length;r<s;r++){var i=e[r];if(/^\s+/.test(i)){for(var o=[];r<e.length;r++){if(!/^\s+/.test(e[r])){r--;break}o.push(e[r].replace(/^\s+/,""))}n[n.length-1].children=a(o)}else n.push({tag:"li",md:e[r],children:[],html:y("ul"==t?e[r].replace(/^[\.\*\-]\s*/,""):e[r].replace(/^\d\.\s*/,""))})}return n}function y(t){return t=_(t),t=t.replace(w.img,'<img alt="$1" src="$2">'),t=t.replace(w.inlineCode,"<code>$1</code>"),t=t.replace(w.a,function(t,e,n){return'<a href="'+n+'" target="_blank">'+y(e.replace(/\\([\(\)\[\])])/g,"$1"))+"</a>"}),t=t.replace(w.b,"<b>$1</b>"),t=t.replace(w.i,"<i>$1</i>")}function _(t){return t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function k(t){for(var e=[],n=0;n<t.length;n++){var r=t[n];if(/^\s+/.test(r)){for(var s=[];n<t.length;n++){if(!/^\s+/.test(t[n])){n--;break}s.push(t[n].replace(/^\s+/,""))}e[e.length-1].children=a(s)}else e.push({tag:"p",md:r,children:[],html:y(r.replace(/^(!)?>/,""))})}return e}function R(t){for(var e=/[^|]+/g,n=t[1].match(e)||[],r=[],s=0,i=n.length;s<i;s++)/^\s*-+:\s*$/.test(n[s])?r.push("right"):/^\s*:-+:\s*$/.test(n[s])?r.push("center"):r.push("left");var o={tag:"tr",children:[]};function a(t){if(t<r.length&&"left"!==r[t])return{"text-align":r[t]}}for(var l=t[0].match(e)||[],c=l.length,u=0;u<c;u++)o.children.push({tag:"th",style:a(u),md:l[u],html:y(l[u].trim())});for(var h=[],d=2,f=t.length;d<f;d++){for(var p={tag:"tr",children:[]},g=c,m=t[d].match(e)||[];g--;){var v=m[g];p.children.unshift({tag:"td",style:a(g),md:v,html:v?y(v.trim()):""})}h.push(p)}return[o].concat(h)}function a(t){for(var e=[],n=t.length,r="",s=0;s<n;s++){var i=t[s];if(w.title.test(i)){var o=/^#{1,6}/,a=i.match(o);a&&e.push({tag:"h"+a[0].length,md:i,html:y(i.replace(o,"").replace(/^\s*/,""))})}else if(w.hr.test(i))e.push({tag:"hr",md:i});else if((r=!!w.ul.test(i)&&"ul")||(r=!!w.ol.test(i)&&"ol")){for(var l=[];s<n;s++){var c=t[s];if(!w[r].test(c)&&!/^\s+.+/.test(c)){s--;break}l.push(c)}e.push({tag:r,children:b(r,l),md:l.join("\n")})}else if(w.table.test(i)&&t[s+1]&&w.align.test(t[s+1])){var u=[i,t[s+1]];for(s+=2;s<n;s++){var h=t[s];if(!w.table.test(h)){s--;break}u.push(h)}e.push({tag:"table",children:R(u),md:u.join("\n")})}else if(w.blockquote.test(i)){var d=[i],f=0==i.indexOf("!")?"warning":"";for(s++;s<n;s++){var p=t[s];if(!w.blockquote.test(p)&&!/^\s+.+/.test(p)){s--;break}d.push(p)}e.push({tag:"blockquote",class:f,children:k(d),md:d.join("\n")})}else if(w.code.test(i)){var g=i.match(/[^`\s]+/);g=g?g[0]:"";var m="";for(s++;s<n;s++){var v=_(t[s]);if(w.code.test(v))break;m+=v,/^\n/.test(v)||(m+="\n")}e.push({tag:"pre",children:[{tag:"code",html:m}],attr:{"data-lang":g},class:g,md:i+"\n"+m+"```"})}else/^\n+/.test(i)||e.push({tag:"p",md:i,html:y(i)})}return e}function l(t){return a(t.match(/.+|^\n/gm)||[])}function t(t){return function t(e){for(var n=[],r=0,s=e.length;r<s;r++){var i=e[r];if("text"==i.tag)n.push(i.html),i.children&&n.push(t(i.children));else{if(n.push("<"+i.tag),i.class&&n.push(' class="'+i.class+'" '),i.style){for(var o in n.push(' style="'),i.style)n.push(o+":"+i.style[o]+";");n.push('" ')}if(i.attr)for(var a in i.attr)n.push(" "+a+'="'+i.attr[a]+'" ');n.push(">"),i.html&&n.push(i.html),i.children&&n.push(t(i.children)),n.push("</"+i.tag+">")}}return n.join("")}(l(t))}var e,n=Object.defineProperty;function c(t){this.editor=t,this.path=[],n(this,"selection",{get:function(){return window.getSelection()}}),n(this,"node",{get:function(){return this._inside()?this.selection.baseNode:null}}),n(this,"offset",{get:function(){return this.selection.baseOffset}})}function r(t,e){var n=document.querySelector(t);if(n){this.elm=n,this._rowNo=0,n.setAttribute("contenteditable","true");var r=[];if(e&&e.markdown&&(r=l(e.markdown)).length){for(var s="",i=0,o=r.length;i<o;i++){var a=r[i];s+='<div row="'+this._rowNo+++'" class="'+a.tag+'">'+(a.md||"")+"</div>"}n.innerHTML=s}else n.innerHTML='<div row="'+this._rowNo+++'"><br></div>';this._initEvent(),this.cursor=new c(n)}return this}return c.prototype._inside=function(){for(var t=this.selection.baseNode,e=[t];t&&!t.isEqualNode(this.editor);)t=t.parentNode,e.push(t);return this.path=e,!!t&&t.isEqualNode(this.editor)},c.prototype.closest=function(e){var n=null;return this._inside()&&this.path.some(function(t){if(t.matches&&t.matches(e))return n=t,!0}),n},c.prototype.closestRow=function(){return this.closest("[row]")},c.prototype.isAtEnd=function(){var t=this.closestRow();if(t){var e=t.childNodes,n=e.length;if(n){var r=e[n-1];return"BR"!==r.nodeName&&(r.isEqualNode(this.node)&&this.offset===r.nodeValue.length)}return!1}return!1},c.prototype.set=function(t,e){var n=window.getSelection(),r=document.createRange();t instanceof Text&&"number"!=typeof e?(e=t.nodeValue.length,r.setStart(t,e)):t instanceof HTMLBRElement&&r.setStart(t,0),r.collapse(!0),n.removeAllRanges(),n.addRange(r)},r.prototype._initEvent=function(){var n=this,t=this.elm.addEventListener;function e(){if(n._lastRow){var t=l(n._lastRow.innerText);if(t.length){var e=t[0];n._lastRow.setAttribute("class",e.tag),e.attr&&Object.keys(e.attr).forEach(function(t){e.attr&&e.attr[t]&&n._lastRow.setAttribute(t,e.attr[t])})}}}t("paste",function(t){t.preventDefault();var e=t.clipboardData.getData("text/plain"),n=document.createElement("div");n.innerText=e,document.execCommand("insertHTML",!1,n.innerHTML.replace(/\s/g,"&nbsp;"))}),t("keydown",function(t){13!==t.keyCode||t.shiftKey?8!==t.keyCode||n.elm.textContent||t.preventDefault():(t.preventDefault(),n.cursor.isAtEnd()&&document.execCommand("insertHTML",!1,"<div row='"+n._rowNo+++"'><br></div>"))}),t("blur",e),this._lastRow=null,document.addEventListener("selectionchange",function(){if(window.getSelection().isCollapsed){var t=n.cursor.closestRow();t?n._lastRow||t.textContent?n._lastRow&&n._lastRow.getAttribute("row")!==t.getAttribute("row")&&e():t.setAttribute("class",""):e(),n._lastRow=t}else n._lastRow=null})},(e=r).prototype.getMarkdown=function(){return this.elm.innerText},e.prototype.getHtml=function(){return t(this.getMarkdown())},e.prototype.setMarkdown=function(t){for(var e=l(t),n="",r=0,s=e.length;r<s;r++){var i=e[r];n+='<div row="'+this._rowNo+++'" class="'+i.tag+'">'+(i.md||"").replace(/\n/g,"<br>")+"</div>"}this.elm.innerHTML=n},e.prototype.insertMarkdown=function(t){document.execCommand("insertText",!1,t)},r});
