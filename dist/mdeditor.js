!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.mdeditor=e()}(this,function(){"use strict";var f={title:/^#{1,6}.+$/,ul:/^[\.\-\*]\s+.+$/,ol:/^\d+\.\s?.+$/,blockquote:/^!?>.+?$/,code:/^\`{3}.*$/,table:/^(\|[^|]+)+\|\s*$/,align:/^(\|\s*:?-+:?\s*)+\|\s*$/,hr:/^(\*|\_|\-){3,}$/,img:/\!\[(.*?)\]\((.*?)\)/g,a:/\[((?:[^\(\)\[\]]|\\\[|\\\]|\\\(|\\\))+)\]\((.+?)\)/g,b:/\*\*(.+?)\*\*/g,i:/\*(.+?)\*/g,inlineCode:/\`(.+?)\`/g};function p(t,e){for(var r=[],n=0;n<e.length;n++){var s=e[n];if(/^\s+/.test(s)){for(var i=[];n<e.length;n++){if(!/^\s+/.test(e[n])){n--;break}i.push(e[n].replace(/^\s+/,""))}r[r.length-1].children=o(i)}else r.push({tag:"li",md:e[n],children:[],html:b("ul"==t?e[n].replace(/^[\.\*\-]\s*/,""):e[n].replace(/^\d\.\s*/,""))})}return r}function b(t){return t=g(t),t=t.replace(f.img,'<img alt="$1" src="$2">'),t=t.replace(f.inlineCode,"<code>$1</code>"),t=t.replace(f.a,function(t,e,r){return'<a href="'+r+'" target="_blank">'+b(e.replace(/\\([\(\)\[\])])/g,"$1"))+"</a>"}),t=t.replace(f.b,"<b>$1</b>"),t=t.replace(f.i,"<i>$1</i>")}function g(t){return t.replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function m(t){for(var e=[],r=0;r<t.length;r++){var n=t[r];if(/^\s+/.test(n)){for(var s=[];r<t.length;r++){if(!/^\s+/.test(t[r])){r--;break}s.push(t[r].replace(/^\s+/,""))}e[e.length-1].children=o(s)}else e.push({tag:"p",md:n,children:[],html:b(n.replace(/^(!)?>/,""))})}return e}function v(t){for(var e=/[^|]+/g,r=t[1].match(e)||[],n=[],s=0,i=r.length;s<i;s++)/^\s*-+:\s*$/.test(r[s])?n.push("right"):/^\s*:-+:\s*$/.test(r[s])?n.push("center"):n.push("left");var o={tag:"tr",children:[]};function a(t){if(t<n.length&&"left"!==n[t])return{"text-align":n[t]}}for(var l=t[0].match(e)||[],c=l.length,u=0;u<c;u++)o.children.push({tag:"th",style:a(u),md:l[u],html:b(l[u].trim())});for(var h=[],d=2,f=t.length;d<f;d++){for(var p={tag:"tr",children:[]},g=c,m=t[d].match(e)||[];g--;){var v=m[g];p.children.unshift({tag:"td",style:a(g),md:v,html:v?b(v.trim()):""})}h.push(p)}return[o].concat(h)}function o(t){for(var e=[],r=t.length,n="",s=0;s<r;s++){var i=t[s];if(f.title.test(i)){var o=/^#{1,6}/,a=i.match(o);a&&e.push({tag:"h"+a[0].length,md:i,html:b(i.replace(o,"").replace(/^\s*/,""))})}else if(f.hr.test(i))e.push({tag:"hr",md:i});else if((n=!!f.ul.test(i)&&"ul")||(n=!!f.ol.test(i)&&"ol")){for(var l=[];s<r;s++){var c=t[s];if(!f[n].test(c)&&!/^\s+.+/.test(c)){s--;break}l.push(c)}e.push({tag:n,children:p(n,l),md:l.join("\n")})}else if(f.table.test(i)&&t[s+1]&&f.align.test(t[s+1])){l=[i,t[s+1]];for(s+=2;s<r;s++){c=t[s];if(!f.table.test(c)){s--;break}l.push(c)}e.push({tag:"table",children:v(l),md:l.join("\n")})}else if(f.blockquote.test(i)){l=[i];var u=0==i.indexOf("!")?"warning":"";for(s++;s<r;s++){c=t[s];if(!f.blockquote.test(c)&&!/^\s+.+/.test(c)){s--;break}l.push(c)}e.push({tag:"blockquote",class:u,children:m(l),md:l.join("\n")})}else if(f.code.test(i)){var h=i.match(/[^`\s]+/);h=h?h[0]:"";var d="";for(s++;s<r;s++){c=g(t[s]);if(f.code.test(c))break;d+=c,/^\n/.test(c)||(d+="\n")}e.push({tag:"pre",children:[{tag:"code",html:d}],attr:{"data-lang":h},class:h,md:i+"\n"+d+"```"})}else/^\n+/.test(i)||e.push({tag:"p",md:i,html:b(i)})}return e}function a(t){return o(t.match(/.+|^\n/gm)||[])}function t(t){return function t(e){for(var r=[],n=0;n<e.length;n++){var s=e[n];if("text"==s.tag)r.push(s.html),s.children&&r.push(t(s.children));else{if(r.push("<"+s.tag),s.class&&r.push(' class="'+s.class+'" '),s.style){for(var i in r.push(' style="'),s.style)r.push(i+":"+s.style[i]+";");r.push('" ')}if(s.attr)for(var o in s.attr)r.push(" "+o+'="'+s.attr[o]+'" ');r.push(">"),s.html&&r.push(s.html),s.children&&r.push(t(s.children)),r.push("</"+s.tag+">")}}return r.join("")}(a(t))}var e,r=Object.defineProperty;function l(t){this.editor=t,this.path=[],r(this,"selection",{get:function(){return window.getSelection()}}),r(this,"node",{get:function(){return this._inside()?this.selection.baseNode:null}}),r(this,"offset",{get:function(){return this.selection.baseOffset}})}function n(t,e){var r=this,n=document.querySelector(t);if(n){this.elm=n,this._rowNo=0,n.setAttribute("contenteditable","true");var s=[];if(e&&e.markdown&&(s=a(e.markdown)).length){var i="";s.forEach(function(t){i+='<div row="'+r._rowNo+++'" class="'+t.tag+'">'+(t.md||"")+"</div>"}),n.innerHTML=i}else n.innerHTML='<div row="'+this._rowNo+++'"><br></div>';this._initEvent(),this.cursor=new l(n)}return this}return l.prototype._inside=function(){for(var t=this.selection.baseNode,e=[t];t&&!t.isEqualNode(this.editor);)t=t.parentNode,e.push(t);return this.path=e,!!t&&t.isEqualNode(this.editor)},l.prototype.closest=function(e){var r=null;return this._inside()&&this.path.some(function(t){if(t.matches&&t.matches(e))return r=t,!0}),r},l.prototype.closestRow=function(){return this.closest("[row]")},n.prototype._initEvent=function(){var r=this,t=this.elm.addEventListener;function e(){if(r._lastRow){var t=a(r._lastRow.innerText);if(t.length){var e=t[0];r._lastRow.setAttribute("class",e.tag),e.attr&&Object.keys(e.attr).forEach(function(t){e.attr&&e.attr[t]&&r._lastRow.setAttribute(t,e.attr[t])})}}}t("paste",function(t){t.preventDefault();var e=t.clipboardData.getData("text/plain"),r=document.createElement("div");r.innerText=e,document.execCommand("insertHTML",!1,r.innerHTML.replace(/\s/g,"&nbsp;"))}),t("keydown",function(t){if(13!==t.keyCode||t.shiftKey)8!==t.keyCode||r.elm.textContent||t.preventDefault();else{t.preventDefault();var e=r.cursor.closestRow();e.textContent&&r.cursor.node===e.childNodes[e.childNodes.length-1]&&r.cursor.node.length===r.cursor.offset&&document.execCommand("insertHTML",!1,"<div row='"+r._rowNo+++"'><br></div>")}}),t("blur",e),this._lastRow=null,document.addEventListener("selectionchange",function(){if(window.getSelection().isCollapsed){var t=r.cursor.closestRow();t?r._lastRow||t.textContent?r._lastRow&&r._lastRow.getAttribute("row")!==t.getAttribute("row")&&e():t.setAttribute("class",""):e(),r._lastRow=t}else r._lastRow=null})},(e=n).prototype.getMarkdown=function(){return this.elm.innerText},e.prototype.getHtml=function(){return t(this.getMarkdown())},e.prototype.setMarkdown=function(t){var e=this,r=a(t),n="";r.forEach(function(t){n+='<div row="'+e._rowNo+++'" class="'+t.tag+'">'+t.md.replace(/\n/g,"<br>")+"</div>"}),this.elm.innerHTML=n},e.prototype.insertMarkdown=function(t){document.execCommand("insertText",!1,t)},n});
